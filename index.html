<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollabX - Collaborative Design</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .canvas-container { border: 1px solid #d1d5db; }
        
        /* Professional Toolbar Styles */
        .tool-btn { position: relative; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: white; border: 1px solid #e5e7eb; border-radius: 8px; transition: all 0.2s ease-in-out; }
        .tool-btn:hover:not(:disabled) { background-color: #f3f4f6; border-color: #d1d5db; transform: scale(1.05); }
        .tool-btn.active { background-color: #e0e7ff; border-color: #a5b4fc; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); }
        .tool-btn:disabled { cursor: not-allowed; background-color: #f9fafb; opacity: 0.5; }
        .tool-btn svg { width: 20px; height: 20px; color: #374151; }
        
        /* Tooltip Styles */
        .tooltip { visibility: hidden; width: auto; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 5px 10px; position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; white-space: nowrap; font-size: 12px; pointer-events: none; }
        .tool-btn:hover .tooltip { visibility: visible; opacity: 1; }

        /* Dropdown & Modal Styles */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; background-color: #ffffff; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 50; border-radius: 8px; padding: 8px 0; border: 1px solid #e5e7eb; top: 110%; left: 50%; transform: translateX(-50%); }
        .dropdown-content button { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 16px; text-align: left; background: none; border: none; cursor: pointer; font-size: 14px; }
        .dropdown-content button:hover { background-color: #f3f4f6; }
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-grid { max-height: 300px; overflow-y: auto; }

        .cursor { position: absolute; width: 20px; height: 20px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"></path></svg>'); background-size: contain; pointer-events: none; z-index: 1000; transition: top 0.05s linear, left 0.05s linear; }
        .cursor-label { position: absolute; left: 20px; top: 20px; background-color: rgba(0, 0, 0, 0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; white-space: nowrap; }
        #pen-width-slider { -webkit-appearance: none; appearance: none; width: 100px; height: 8px; background: #d1d5db; border-radius: 5px; outline: none; }
        #pen-width-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #4f46e5; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-200">

    <div id="home-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
         <div class="bg-white p-12 rounded-lg shadow-xl text-center max-w-md w-full">
            <h1 class="text-4xl font-bold text-slate-900 mb-2">CollabX</h1>
            <p class="text-slate-500 mb-8">Real-time collaboration, simplified.</p>
            <button id="create-room-btn" class="w-full bg-slate-900 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-slate-700 mb-6 text-lg transition-all">Create a New Canvas</button>
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-slate-300"></div>
                <span class="flex-shrink mx-4 text-slate-400 text-sm">Or Join an Existing One</span>
                <div class="flex-grow border-t border-slate-300"></div>
            </div>
            <div class="flex items-center mt-4">
                <input type="text" id="room-id-input" placeholder="Enter Room ID" class="text-center w-full border-2 border-slate-300 bg-white h-12 px-5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-slate-400 focus:border-slate-400">
                <button id="join-room-btn" class="bg-white text-slate-800 font-semibold py-3 px-5 rounded-lg shadow ml-2 border-2 border-slate-300 hover:bg-slate-50 transition-all">Join</button>
            </div>
        </div>
        <footer class="text-center mt-8 text-slate-500 text-sm"><p>Built with Node.js, Socket.IO, and Fabric.js</p></footer>
    </div>

    <div id="canvas-screen" class="hidden w-full max-w-7xl mx-auto p-4">
        <header class="bg-white rounded-lg shadow-md p-4 mb-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Design Canvas</h1>
                <p class="text-sm text-gray-500">Room ID: <span id="room-id-display" class="font-mono bg-gray-200 px-2 py-1 rounded cursor-pointer" title="Click to copy"></span></p>
            </div>
             <div id="voice-chat-controls" class="flex items-center gap-4">
                <button id="join-voice-btn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-teal-600 transition-all">Join Voice</button>
                <button id="mute-btn" class="bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-500 hidden transition-all">Mute</button>
                <div id="voice-status" class="text-sm text-gray-600"></div>
            </div>
        </header>

        <div id="toolbar" class="bg-white rounded-lg shadow-md p-2 mb-4 flex flex-wrap items-center gap-2">
            <!-- History -->
            <button id="undo-btn" class="tool-btn" disabled><span class="tooltip">Undo (Ctrl+Z)</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9h12a5 5 0 015 5v0a5 5 0 01-5 5H7.5"/><path d="M6 12L3 9l3-3"/></svg></button>
            <button id="redo-btn" class="tool-btn" disabled><span class="tooltip">Redo (Ctrl+Y)</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 9H9a5 5 0 00-5 5v0a5 5 0 005 5h8.5"/><path d="M18 12l3 3-3 3"/></svg></button>
            <div class="h-6 border-l border-gray-300 mx-2"></div>
            
            <!-- Tools -->
            <button id="select-tool-btn" class="tool-btn active"><span class="tooltip">Select</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg></button>
            <button id="pen-tool-btn" class="tool-btn"><span class="tooltip">Pen</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button>
            <button id="eraser-tool-btn" class="tool-btn"><span class="tooltip">Eraser</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.49 4.51a2.828 2.828 0 00-4 0L8 13l-4 4 4-1 9-9a2.828 2.828 0 000-4zM16 8l4 4"/><path d="M12 17H4"/></svg></button>
            <div id="pen-options" class="hidden items-center gap-2 ml-2">
                <input type="color" id="pen-color-picker" value="#000000" class="h-8 w-8 p-1 border-2 border-gray-200 rounded-md cursor-pointer">
                <input type="range" id="pen-width-slider" min="1" max="50" value="5" class="cursor-pointer">
                <span id="pen-width-label" class="text-sm font-mono w-6 text-center">5</span>
            </div>
            <div class="h-6 border-l border-gray-300 mx-2"></div>

            <!-- Shapes -->
            <div class="dropdown">
                <button id="shapes-tool-btn" class="tool-btn"><span class="tooltip">Shapes</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.17 12H2.83a1 1 0 00-.83 1.57l9.17 10.19a1 1 0 001.66 0l9.17-10.19a1 1 0 00-.83-1.57zM12 2L2 7l10 5 10-5-10-5z"/></svg></button>
                <div id="shapes-dropdown" class="dropdown-content">
                    <button id="add-rect"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>Rectangle</button>
                    <button id="add-circle"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>Circle</button>
                    <button id="add-triangle"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 22h20L12 2z"/></svg>Triangle</button>
                    <button id="add-line"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="19" x2="19" y2="5"/></svg>Line</button>
                    <button id="add-arrow"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>Arrow</button>
                    <button id="add-star"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Star</button>
                </div>
            </div>

            <!-- Add -->
            <button id="add-text-btn" class="tool-btn"><span class="tooltip">Text</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg></button>
            <label for="image-loader-input" class="tool-btn cursor-pointer"><span class="tooltip">Image</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></label>
            <input type="file" id="image-loader-input" class="hidden" accept="image/*"/>
            <button id="sticker-btn" class="tool-btn"><span class="tooltip">Stickers</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><path d="M9 9h.01"/><path d="M15 9h.01"/></svg></button>
            <div class="h-6 border-l border-gray-300 mx-2"></div>
            
            <!-- Arrange & Delete -->
            <button id="bring-to-front" class="tool-btn" disabled><span class="tooltip">Bring to Front</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="6" width="14" height="14" rx="2" ry="2"/><path d="M16 2H8a2 2 0 00-2 2v2"/></svg></button>
            <button id="send-to-back" class="tool-btn" disabled><span class="tooltip">Send to Back</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="8" y="2" width="14" height="14" rx="2" ry="2"/><path d="M2 12V8a2 2 0 012-2h4"/></svg></button>
            <button id="delete-selected" class="tool-btn ml-auto" disabled><span class="tooltip">Delete</span><svg class="text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
        </div>

        <div id="canvas-wrapper" class="relative bg-white rounded-lg shadow-lg overflow-hidden">
            <canvas id="canvas" width="1000" height="700"></canvas>
            <div id="cursor-container" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
        </div>
        <div id="remote-audio-container"></div>
    </div>
    
    <!-- Sticker Modal -->
    <div id="sticker-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Select a Sticker</h2>
                <button id="close-sticker-modal" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div id="sticker-grid" class="grid grid-cols-6 sm:grid-cols-8 gap-4 text-3xl text-center modal-grid">
                <!-- Stickers will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
        const homeScreen = document.getElementById('home-screen');
        const canvasScreen = document.getElementById('canvas-screen');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomIdInput = document.getElementById('room-id-input');
        const roomIdDisplay = document.getElementById('room-id-display');

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        if (roomId) {
            homeScreen.classList.add('hidden');
            canvasScreen.classList.remove('hidden');
            roomIdDisplay.textContent = roomId;
            initializeCanvas(roomId);
        } else {
            homeScreen.classList.remove('hidden');
            canvasScreen.classList.add('hidden');
        }

        createRoomBtn.addEventListener('click', () => { const newRoomId = Math.random().toString(36).substring(2, 8); window.location.search = `?room=${newRoomId}`; });
        joinRoomBtn.addEventListener('click', () => { const roomIdToJoin = roomIdInput.value.trim(); if (roomIdToJoin) { window.location.search = `?room=${roomIdToJoin}`; } });
        roomIdDisplay.addEventListener('click', () => { navigator.clipboard.writeText(roomId).then(() => { const originalText = roomIdDisplay.textContent; roomIdDisplay.textContent = 'Copied!'; setTimeout(() => { roomIdDisplay.textContent = originalText; }, 1500); }); });

        function initializeCanvas(currentRoomId) {
            const socket = io('http://localhost:3001');
            socket.on('connect', () => { console.log(`✅ Connected with ID: ${socket.id}`); socket.emit('join-room', currentRoomId); });

            const canvas = new fabric.Canvas('canvas', { backgroundColor: '#ffffff' });
            let isUpdatingFromSocket = false;
            let lastPenColor = '#000000';
            
            // --- Get all new toolbar elements ---
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const selectToolBtn = document.getElementById('select-tool-btn');
            const penToolBtn = document.getElementById('pen-tool-btn');
            const eraserToolBtn = document.getElementById('eraser-tool-btn');
            const penOptions = document.getElementById('pen-options');
            const penColorPicker = document.getElementById('pen-color-picker');
            const penWidthSlider = document.getElementById('pen-width-slider');
            const penWidthLabel = document.getElementById('pen-width-label');
            const shapesToolBtn = document.getElementById('shapes-tool-btn');
            const shapesDropdown = document.getElementById('shapes-dropdown');
            const addRectBtn = document.getElementById('add-rect');
            const addCircleBtn = document.getElementById('add-circle');
            const addTriangleBtn = document.getElementById('add-triangle');
            const addLineBtn = document.getElementById('add-line');
            const addArrowBtn = document.getElementById('add-arrow');
            const addStarBtn = document.getElementById('add-star');
            const addTextBtn = document.getElementById('add-text-btn');
            const imageLoaderInput = document.getElementById('image-loader-input');
            const stickerBtn = document.getElementById('sticker-btn');
            const deleteBtn = document.getElementById('delete-selected');
            const bringToFrontBtn = document.getElementById('bring-to-front');
            const sendToBackBtn = document.getElementById('send-to-back');
            const cursorContainer = document.getElementById('cursor-container');
            const joinVoiceBtn = document.getElementById('join-voice-btn');
            const muteBtn = document.getElementById('mute-btn');
            const voiceStatus = document.getElementById('voice-status');
            const remoteAudioContainer = document.getElementById('remote-audio-container');
            const stickerModal = document.getElementById('sticker-modal');
            const closeStickerModalBtn = document.getElementById('close-sticker-modal');
            const stickerGrid = document.getElementById('sticker-grid');

            // --- Tool Management Logic ---
            let activeTool = 'select';
            const toolButtons = [selectToolBtn, penToolBtn, eraserToolBtn];

            function setActiveTool(tool, button) {
                activeTool = tool;
                toolButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                canvas.isDrawingMode = (tool === 'pen' || tool === 'eraser');
                canvas.selection = (tool === 'select');
                canvas.getObjects().forEach(obj => obj.selectable = (tool === 'select'));

                if (canvas.isDrawingMode) {
                    penOptions.style.display = 'flex';
                    if (tool === 'pen') {
                        canvas.freeDrawingBrush.color = lastPenColor;
                        penColorPicker.value = lastPenColor;
                        penColorPicker.disabled = false;
                    } else { // Eraser
                        canvas.freeDrawingBrush.color = '#ffffff';
                        penColorPicker.value = '#ffffff';
                        penColorPicker.disabled = true;
                    }
                } else {
                    penOptions.style.display = 'none';
                }
            }

            selectToolBtn.addEventListener('click', () => setActiveTool('select', selectToolBtn));
            penToolBtn.addEventListener('click', () => setActiveTool('pen', penToolBtn));
            eraserToolBtn.addEventListener('click', () => setActiveTool('eraser', eraserToolBtn));
            
            penColorPicker.addEventListener('input', (e) => { lastPenColor = e.target.value; if (activeTool === 'pen') canvas.freeDrawingBrush.color = lastPenColor; });
            penWidthSlider.addEventListener('input', (e) => { const newWidth = parseInt(e.target.value, 10); canvas.freeDrawingBrush.width = newWidth; penWidthLabel.textContent = newWidth; });
            canvas.freeDrawingBrush.width = parseInt(penWidthSlider.value, 10);

            // --- Dropdown and Modal Logic ---
            shapesToolBtn.addEventListener('click', () => { shapesDropdown.style.display = shapesDropdown.style.display === 'block' ? 'none' : 'block'; });
            document.addEventListener('click', (e) => { if (!shapesToolBtn.parentElement.contains(e.target)) shapesDropdown.style.display = 'none'; });

            stickerBtn.addEventListener('click', () => { stickerModal.style.display = 'flex'; });
            closeStickerModalBtn.addEventListener('click', () => { stickerModal.style.display = 'none'; });
            window.addEventListener('click', (e) => { if (e.target == stickerModal) stickerModal.style.display = 'none'; });

            // Populate Stickers
            const stickers = ['👍', '❤️', '🚀', '🎉', '😂', '🔥', '💡', '✅', '❌', '🤔', '🙌', '💯', '🙏', '😎', '😮', '😢', '🤯', '🥳'];
            stickers.forEach(s => { const btn = document.createElement('button'); btn.textContent = s; btn.className = 'hover:bg-gray-200 p-2 rounded-lg'; btn.onclick = () => { addSticker(s); stickerModal.style.display = 'none'; }; stickerGrid.appendChild(btn); });

            // --- History Logic ---
            const saveState = () => { if (!isUpdatingFromSocket) socket.emit('history:save', canvas.toObject(['objectId'])); };
            undoBtn.addEventListener('click', () => socket.emit('history:undo'));
            redoBtn.addEventListener('click', () => socket.emit('history:redo'));
            socket.on('history:update', (status) => { undoBtn.disabled = !status.canUndo; redoBtn.disabled = !status.canRedo; });
            socket.on('canvas:load', (canvasState) => { isUpdatingFromSocket = true; canvas.loadFromJSON(canvasState, () => { canvas.renderAll(); isUpdatingFromSocket = false; setActiveTool(activeTool, document.querySelector('.tool-btn.active')); }); });

            // --- Object Creation Logic ---
            function addObjectAndSave(obj) { canvas.add(obj); socket.emit('object:added', obj.toObject(['objectId'])); saveState(); }
            function closeDropdowns() { shapesDropdown.style.display = 'none'; }
            
            addRectBtn.addEventListener('click', () => { setActiveTool('select', selectToolBtn); const rect = new fabric.Rect({ left: 100, top: 100, fill: '#3b82f6', width: 150, height: 100, objectId: generateId() }); addObjectAndSave(rect); closeDropdowns(); });
            addCircleBtn.addEventListener('click', () => { setActiveTool('select', selectToolBtn); const circle = new fabric.Circle({ left: 200, top: 200, radius: 60, fill: '#22c55e', objectId: generateId() }); addObjectAndSave(circle); closeDropdowns(); });
            addTriangleBtn.addEventListener('click', () => { setActiveTool('select', selectToolBtn); const triangle = new fabric.Triangle({ left: 300, top: 150, width: 100, height: 100, fill: '#f97316', objectId: generateId() }); addObjectAndSave(triangle); closeDropdowns(); });
            addLineBtn.addEventListener('click', () => { setActiveTool('select', selectToolBtn); const line = new fabric.Line([50, 100, 200, 200], { left: 150, top: 150, stroke: '#1f2937', strokeWidth: 5, objectId: generateId() }); addObjectAndSave(line); closeDropdowns(); });
            addStarBtn.addEventListener('click', () => { setActiveTool('select', selectToolBtn); const star = new fabric.Polygon([ {x: 350, y: 75}, {x: 380, y: 160}, {x: 470, y: 160}, {x: 400, y: 215}, {x: 420, y: 300}, {x: 350, y: 250}, {x: 280, y: 300}, {x: 300, y: 215}, {x: 230, y: 160}, {x: 320, y: 160} ], { fill: '#facc15', objectId: generateId() }); addObjectAndSave(star); closeDropdowns(); });
            addArrowBtn.addEventListener('click', () => { setActiveTool('select', selectToolBtn); const line = new fabric.Line([50, 100, 200, 100], { left: 250, top: 250, stroke: '#ef4444', strokeWidth: 5, objectId: generateId() }); const arrowHead = new fabric.Triangle({ left: 200, top: 90, width: 20, height: 20, angle: 90, fill: '#ef4444' }); const arrow = new fabric.Group([line, arrowHead], { left: 200, top: 200, objectId: generateId() }); addObjectAndSave(arrow); closeDropdowns(); });
            addTextBtn.addEventListener('click', () => { setActiveTool('select', selectToolBtn); const text = new fabric.IText('Type here...', { left: 300, top: 300, fill: '#8b5cf6', fontSize: 40, objectId: generateId() }); addObjectAndSave(text); });
            imageLoaderInput.addEventListener('change', (e) => { setActiveTool('select', selectToolBtn); const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (f) => { const data = f.target.result; fabric.Image.fromURL(data, (img) => { img.scaleToWidth(200); img.set({ left: 400, top: 400, objectId: generateId() }); addObjectAndSave(img); }); }; reader.readAsDataURL(file); e.target.value = ''; });
            function addSticker(stickerText) { setActiveTool('select', selectToolBtn); const sticker = new fabric.IText(stickerText, { left: 250, top: 250, fontSize: 100, objectId: generateId() }); addObjectAndSave(sticker); }
            
            // --- Event Listeners ---
            canvas.on('path:created', (e) => { if (e.path) { e.path.objectId = generateId(); socket.emit('path:created', e.path.toObject(['objectId'])); saveState(); } });
            canvas.on('object:modified', (e) => { if (e.target && !isUpdatingFromSocket) { socket.emit('object:modified', e.target.toObject(['objectId'])); saveState(); } });
            bringToFrontBtn.addEventListener('click', () => { const obj = canvas.getActiveObject(); if (obj) { canvas.bringToFront(obj); socket.emit('object:layered', { objectId: obj.objectId, action: 'front' }); saveState(); } });
            sendToBackBtn.addEventListener('click', () => { const obj = canvas.getActiveObject(); if (obj) { canvas.sendToBack(obj); socket.emit('object:layered', { objectId: obj.objectId, action: 'back' }); saveState(); } });
            deleteBtn.addEventListener('click', () => { const obj = canvas.getActiveObject(); if (obj) { canvas.remove(obj); socket.emit('object:removed', { objectId: obj.objectId }); saveState(); } });
            canvas.on('selection:created', updateArrangeButtons); canvas.on('selection:updated', updateArrangeButtons); canvas.on('selection:cleared', updateArrangeButtons);
            function updateArrangeButtons() { const activeObject = canvas.getActiveObject(); const enabled = !!activeObject; deleteBtn.disabled = !enabled; bringToFrontBtn.disabled = !enabled; sendToBackBtn.disabled = !enabled; }
            
            // --- Socket Receivers ---
            socket.on('object:added', (data) => {
                const addObjectToCanvas = (obj) => { if (obj) canvas.add(obj); };
                if (data.type === 'path') fabric.Path.fromObject(data, addObjectToCanvas);
                else if (data.type === 'rect') addObjectToCanvas(new fabric.Rect(data));
                else if (data.type === 'circle') addObjectToCanvas(new fabric.Circle(data));
                else if (data.type === 'triangle') addObjectToCanvas(new fabric.Triangle(data));
                else if (data.type === 'line') addObjectToCanvas(new fabric.Line(data.points, data));
                else if (data.type === 'polygon') fabric.Polygon.fromObject(data, addObjectToCanvas); // for Star
                else if (data.type === 'group') fabric.Group.fromObject(data, addObjectToCanvas); // for Arrow
                else if (data.type === 'i-text') addObjectToCanvas(new fabric.IText(data.text, data));
                else if (data.type === 'image') fabric.Image.fromURL(data.src, img => { img.set(data); addObjectToCanvas(img); });
            });
            socket.on('path:created', (data) => { fabric.Path.fromObject(data, (path) => { canvas.add(path); }); });
            socket.on('object:modified', (data) => { const obj = canvas.getObjects().find(o => o.objectId === data.objectId); if (obj) { isUpdatingFromSocket = true; obj.set(data); canvas.renderAll(); isUpdatingFromSocket = false; } });
            socket.on('object:removed', (data) => { const obj = canvas.getObjects().find(o => o.objectId === data.objectId); if (obj) canvas.remove(obj); });
            socket.on('object:layered', (data) => { const obj = canvas.getObjects().find(o => o.objectId === data.objectId); if (obj) { if (data.action === 'front') canvas.bringToFront(obj); else if (data.action === 'back') canvas.sendToBack(obj); } });
            
            // --- Voice Chat & Cursors (No major changes) ---
            let localStream; let peerConnections = {}; let isMuted = false;
            const peerConnectionConfig = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
            joinVoiceBtn.addEventListener('click', async () => { try { localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false }); joinVoiceBtn.style.display = 'none'; muteBtn.style.display = 'block'; voiceStatus.textContent = "Connecting..."; localStream.getAudioTracks()[0].enabled = !isMuted; muteBtn.textContent = isMuted ? 'Unmute' : 'Mute'; socket.emit('join-voice'); } catch (error) { console.error("Mic error:", error); alert("Could not access microphone."); } });
            muteBtn.addEventListener('click', () => { isMuted = !isMuted; localStream.getAudioTracks()[0].enabled = !isMuted; muteBtn.textContent = isMuted ? 'Unmute' : 'Mute'; muteBtn.classList.toggle('bg-red-500', isMuted); muteBtn.classList.toggle('bg-gray-400', !isMuted); });
            function createPeerConnection(targetSocketId, isCaller) { const pc = new RTCPeerConnection(peerConnectionConfig); peerConnections[targetSocketId] = pc; localStream.getTracks().forEach(track => pc.addTrack(track, localStream)); pc.ontrack = (event) => { let audio = document.getElementById(`audio-${targetSocketId}`); if (!audio) { audio = document.createElement('audio'); audio.id = `audio-${targetSocketId}`; audio.autoplay = true; remoteAudioContainer.appendChild(audio); } audio.srcObject = event.streams[0]; }; pc.onicecandidate = (event) => { if (event.candidate) socket.emit('ice-candidate', { target: targetSocketId, candidate: event.candidate }); }; if (isCaller) pc.createOffer().then(offer => pc.setLocalDescription(offer)).then(() => socket.emit('offer', { target: targetSocketId, caller: socket.id, sdp: pc.localDescription })); return pc; }
            socket.on('other-users', (ids) => { voiceStatus.textContent = `In voice chat. Users: ${ids.length + 1}`; ids.forEach(id => createPeerConnection(id, true)); });
            socket.on('offer', (p) => { const pc = createPeerConnection(p.caller, false); pc.setRemoteDescription(new RTCSessionDescription(p.sdp)).then(() => pc.createAnswer()).then(a => pc.setLocalDescription(a)).then(() => socket.emit('answer', { target: p.caller, callee: socket.id, sdp: pc.localDescription })); });
            socket.on('answer', (p) => { const pc = peerConnections[p.callee]; if (pc) pc.setRemoteDescription(new RTCSessionDescription(p.sdp)); });
            socket.on('ice-candidate', (p) => { const pc = peerConnections[p.sender]; if (pc) pc.addIceCandidate(new RTCIceCandidate(p.candidate)).catch(console.error); });
            socket.on('user-left-voice', (d) => { if (peerConnections[d.id]) { peerConnections[d.id].close(); delete peerConnections[d.id]; } const audio = document.getElementById(`audio-${d.id}`); if (audio) audio.remove(); voiceStatus.textContent = `In voice chat. Users: ${Object.keys(peerConnections).length + 1}`; });
            
            const cursors = {};
            canvas.on('mouse:move', (e) => { if (!canvas.isDrawingMode) { const p = canvas.getPointer(e.e); socket.emit('cursor:move', { x: p.x, y: p.y }); } });
            canvas.on('mouse:out', () => socket.emit('cursor:move', { x: -1, y: -1 }));
            socket.on('cursor:move', (d) => { let c = cursors[d.id]; if (!c) { const l = document.createElement('div'); l.className = 'cursor-label'; l.textContent = `User ${d.id.substring(0, 4)}`; c = document.createElement('div'); c.className = 'cursor'; c.appendChild(l); c.style.filter = `hue-rotate(${Math.random() * 360}deg)`; cursorContainer.appendChild(c); cursors[d.id] = c; } if (d.x < 0) c.style.display = 'none'; else { c.style.display = 'block'; c.style.left = `${d.x}px`; c.style.top = `${d.y}px`; } });
            socket.on('user:disconnected', (d) => { if (cursors[d.id]) { cursors[d.id].remove(); delete cursors[d.id]; } });
            function generateId() { return Date.now() + Math.random().toString(36); }
        }
    </script>
</body>
</html>

